<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
        font-family: 'Poppins', sans-serif;
        scroll-behavior: smooth;
    }
    .btn-primary {
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .journal-card {
        padding: 20px 0;
    }
    .journal-card:last-child {
        border-bottom: none !important;
    }
    .journal-card:hover {
        background-color: #f9fafb;
        cursor: pointer;
    }
  </style>
</head>
<body class="font-poppins bg-white">

  <!-- Navbar -->
  <nav class="bg-[#2E619F] text-white p-4 md:p-6 sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center">
            <img src="../Illustrations/Logo.png" alt="GWS logo" class="h-8 md:h-10 w-auto mr-2">
        </div>
        <div class="hidden md:flex space-x-6 items-center">
            <a href="journal.html" class="hover:underline hover:text-blue-200 transition">Journal</a>
            <a href="tracker.html" class="hover:underline hover:text-blue-200 transition">Tracker</a>
            <a href="article.html" class="hover:underline hover:text-blue-200 transition">Articles</a>
            <a href="music.html" class="hover:underline hover:text-blue-200 transition">Music</a>
            <div class="relative group flex items-center space-x-1">
                <button id="avatar-button" class="focus:outline-none">
                    <img src="../Illustrations/Generic avatar.png" width="40" height="40" class="rounded-full cursor-pointer">
                </button>
                <span id="username" class="text-white font-bold">Lucille</span>
                <div id="avatar-dropdown" class="hidden absolute right-0 top-full mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 group-hover:block">
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                    <a href="login.html" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Logout</a>
                </div>
            </div>
        </div>
        <button class="md:hidden text-2xl" id="mobile-menu-button">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div class="md:hidden hidden bg-[#1a4a7f] w-full" id="mobile-menu">
        <div class="container mx-auto py-4 flex flex-col space-y-4">
            <a href="journal.html" class="hover:underline hover:text-blue-200 transition">Journal</a>
            <a href="tracker.html" class="hover:underline hover:text-blue-200 transition">Tracker</a>
            <a href="article.html" class="hover:underline hover:text-blue-200 transition">Articles</a>
            <a href="music.html" class="hover:underline hover:text-blue-200 transition">Music</a>
            <a href="login.html" class="text-red-400 hover:underline">Logout</a>
        </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mx-auto p-4 md:p-8 max-w-6xl">
    <h1 class="text-3xl font-bold mb-8 text-[#2E619F]">Your Journals</h1>
    
    <div class="flex justify-between items-center mb-6">
      <div class="flex items-center bg-[#5B8EC3] text-white px-4 py-2 rounded">
        <span class="text-sm font-medium mr-2">Friday, March 14th</span>
        <button class="text-white">
          <i class="fas fa-caret-down"></i>
        </button>
      </div>
      <button class="flex items-center text-gray-600 hover:text-gray-800">
        <span class="mr-1">Sort by</span>
        <i class="fas fa-caret-down"></i>
      </button>
    </div>

    <div class="border-t-2 border-[#2E619F] mb-6"></div>

    <!-- Entry Container -->
    <div id="journal-entries">
      <!-- Populated dynamically -->
    </div>

    <!-- Empty Message -->
    <div id="empty-state" class="text-center py-16 text-gray-400 hidden">
      <p class="text-lg mb-2">Start adding your entries by clicking the '+' button.</p>
    </div>
  </div>

  <!-- Add Entry Button -->
  <a href="./journal-editor.html">
    <button class="fixed bottom-8 right-8 bg-[#2E619F] text-white rounded-full h-16 w-16 flex items-center justify-center text-3xl z-50 hover:scale-105 transition-transform shadow-lg">
      +
    </button>
  </a>

  <!-- JS Section -->
  <script>
    // Dropdown toggle
    document.getElementById('avatar-button').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('avatar-dropdown').classList.toggle('hidden');
    });

    // Close dropdown outside
    document.addEventListener('click', function() {
        document.getElementById('avatar-dropdown').classList.add('hidden');
    });

    // Mobile menu toggle
    document.getElementById('mobile-menu-button').addEventListener('click', function() {
        document.getElementById('mobile-menu').classList.toggle('hidden');
    });

    // Function to format time from date
    function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
        });
    }

    // Function to extract clean text content from HTML or plain text
    function extractTextContent(content) {
        if (!content || content.trim() === '') {
            return '';
        }

        let textContent = '';
        
        // If content contains HTML tags, extract text content while preserving structure
        if (content.includes('<')) {
            // First convert HTML line breaks to actual line breaks
            let htmlContent = content
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<\/p>/gi, '\n')
                .replace(/<\/div>/gi, '\n')
                .replace(/<\/h[1-6]>/gi, '\n');
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            textContent = tempDiv.textContent || tempDiv.innerText || '';
        } else {
            textContent = content;
        }
        
        // Clean up excessive whitespace but preserve line breaks
        textContent = textContent
            .replace(/[ \t]+/g, ' ')  // Replace multiple spaces/tabs with single space
            .replace(/\n\s+/g, '\n')  // Remove spaces after line breaks
            .replace(/\s+\n/g, '\n')  // Remove spaces before line breaks
            .trim();
        
        return textContent;
    }

    // Function to split content into title and description
    function parseContentForDisplay(content) {
        const textContent = extractTextContent(content);
        
        if (!textContent) {
            return {
                title: 'Untitled Entry',
                description: ''
            };
        }

        // First, try splitting by line breaks (paragraphs)
        // Handle multiple types of line breaks
        let paragraphs = textContent
            .split(/\n+/)  // Split on one or more line breaks
            .map(p => p.trim())  // Trim each paragraph
            .filter(p => p.length > 0);  // Remove empty paragraphs
        
        console.log('Paragraphs found:', paragraphs);  // Debug log
        
        if (paragraphs.length > 1) {
            // Use first paragraph as title
            let title = paragraphs[0];
            
            // Limit title length
            if (title.length > 60) {
                title = title.substring(0, 60) + '...';
            }
            
            // Use remaining paragraphs as description
            let description = paragraphs.slice(1).join(' ').trim();
            
            // Limit description length
            if (description.length > 120) {
                description = description.substring(0, 120) + '...';
            }
            
            return {
                title: title || 'Untitled Entry',
                description: description
            };
        }

        // If no line breaks, split by sentence punctuation
        let sentences = textContent.split(/[.!?]+/).filter(s => s.trim().length > 0);
        
        // If no sentence breaks, try splitting by length for very long single sentences
        if (sentences.length === 1 && textContent.length > 60) {
            // Find a good break point (space near the middle)
            const midPoint = Math.min(60, textContent.length / 2);
            const spaceIndex = textContent.indexOf(' ', midPoint);
            
            if (spaceIndex > 0 && spaceIndex < textContent.length - 10) {
                const title = textContent.substring(0, spaceIndex).trim();
                const description = textContent.substring(spaceIndex).trim();
                
                return {
                    title: title || 'Untitled Entry',
                    description: description.length > 120 ? description.substring(0, 120) + '...' : description
                };
            }
        }

        // Use first sentence as title
        let title = sentences[0] ? sentences[0].trim() : textContent;
        
        // Limit title length
        if (title.length > 60) {
            title = title.substring(0, 60) + '...';
        }

        // Use remaining sentences as description
        let description = '';
        if (sentences.length > 1) {
            description = sentences.slice(1).join('. ').trim();
            if (description && !description.endsWith('.') && !description.endsWith('!') && !description.endsWith('?')) {
                description += '.';
            }
        }

        // Limit description length
        if (description.length > 120) {
            description = description.substring(0, 120) + '...';
        }

        return {
            title: title || 'Untitled Entry',
            description: description
        };
    }

    // Load and display journal entries
    document.addEventListener('DOMContentLoaded', function() {
        const allEntries = JSON.parse(localStorage.getItem('journalEntries') || '{}');
        const entriesList = document.getElementById('journal-entries');
        const emptyState = document.getElementById('empty-state');

        if (Object.keys(allEntries).length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }

        // Sort entries by date (newest first)
        const sortedEntries = Object.values(allEntries).sort((a, b) => {
            return new Date(b.date) - new Date(a.date);
        });

        sortedEntries.forEach(entry => {
            const entryElement = document.createElement('div');
            entryElement.className = 'journal-card border-b border-[#2E619F] px-4 py-5 hover:bg-gray-50 transition-colors cursor-pointer';
            
            // Parse content into title and description
            const { title, description } = parseContentForDisplay(entry.content);

            // Format timestamp
            const timestamp = formatTime(entry.date);
            
            entryElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${title}</h3>
                        ${description ? `<p class="text-gray-600 leading-relaxed">${description}</p>` : ''}
                    </div>
                    <div class="ml-4 flex-shrink-0">
                        <span class="text-sm text-gray-400">${timestamp}</span>
                    </div>
                </div>
            `;
            
            // Add click handler to navigate to editor with entry
            entryElement.addEventListener('click', function() {
                // Store the selected entry for editing
                localStorage.setItem('editingEntry', JSON.stringify(entry));
                window.location.href = './journal-editor.html';
            });
            
            entriesList.appendChild(entryElement);
        });

        emptyState.classList.add('hidden');
    });
  </script>
</body>
</html>